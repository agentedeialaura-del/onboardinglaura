<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Onboarding de Clientes - Laura IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #E5E7EB; }
        .kanban-column { min-width: 320px; width: 320px; background-color: #1F2937; border-radius: 0.75rem; }
        .kanban-card { cursor: grab; background-color: #374151; border: 1px solid #4B5563; transition: all 0.2s; position: relative; }
        .kanban-card:hover { box-shadow: 0 0 15px rgba(99, 102, 241, 0.3); border-color: #6366F1; }
        .kanban-card:active { cursor: grabbing; }
        .dragging { opacity: 0.6; transform: rotate(3deg); }
        .drag-over { background-color: rgba(99, 102, 241, 0.1); border: 2px dashed #4F46E5; }
        .progress-bar-bg { background-color: #4B5563; }
        .progress-bar-fg { background-color: #4F46E5; transition: width 0.3s ease-in-out; }
        .modal-bg { background-color: rgba(0, 0, 0, 0.7); }
        .modal-content-dark { background-color: #1F2937; border: 1px solid #4B5563; }
        .header-dark { background-color: #1F2937; border-bottom: 1px solid #374151; }
        .select-dark, .input-dark, .textarea-dark { background-color: #374151; border-color: #4B5563; color: #E5E7EB; }
        .checkbox-dark:checked { background-color: #4F46E5; border-color: #4F46E5; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.2s; }
        .btn-indigo { background-color: #4F46E5; color: white; }
        .btn-indigo:hover { background-color: #4338CA; }
        .btn-danger { background-color: #991B1B; color: white; }
        .btn-danger:hover { background-color: #7F1D1D; }
        .add-task-btn { background-color: transparent; color: #9CA3AF; transition: all 0.2s; }
        .add-task-btn:hover { background-color: #374151; color: #E5E7EB; }
        .delete-task-btn { position: absolute; top: 8px; right: 8px; color: #9CA3AF; background: none; border: none; cursor: pointer; padding: 4px; border-radius: 50%; opacity: 0; transition: all 0.2s; }
        .kanban-card:hover .delete-task-btn { opacity: 1; }
        .delete-task-btn:hover { color: #F87171; background-color: #4B5563; }
    </style>
</head>
<body class="antialiased">

    <header class="header-dark shadow-lg p-4">
        <div class="container mx-auto flex justify-between items-center flex-wrap gap-4">
            <div class="flex items-center space-x-4">
                <img src="https://laura-ia.com.br/wp-content/uploads/2025/06/claralogo-e1750978255121-1024x304.png" alt="Logo Laura IA" class="h-10">
                <div>
                    <h1 class="text-2xl font-bold text-white">Painel de Onboarding</h1>
                    <p class="text-sm text-gray-400">Status de implementa√ß√£o dos projetos.</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button id="add-project-btn" class="btn btn-indigo"><i class="fas fa-plus mr-2"></i>Adicionar Projeto</button>
                <div class="flex items-center space-x-2">
                    <label for="client-select" class="font-semibold text-gray-300">Cliente:</label>
                    <select id="client-select" class="select-dark p-2 border rounded-md shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></select>
                    <button id="remove-project-btn" title="Remover Projeto Atual" class="btn btn-danger"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>
        </div>
    </header>

    <main id="kanban-board" class="container mx-auto p-4 lg:p-6">
        <div id="board-container" class="flex space-x-6 overflow-x-auto pb-4"></div>
    </main>

    <div id="task-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-bg">
        <div class="modal-content-dark rounded-lg shadow-2xl w-11/12 max-w-2xl mx-auto" id="modal-content"></div>
    </div>
    
    <script>
        // --- TEMPLATE DE TAREFAS PADR√ÉO ---
        const projectTemplate = {
            columns: [
                { id: 'todo', title: 'üìã A Fazer / Briefing', tasks: [
                    { title: 'Reuni√£o de Kick-off e Briefing', description: 'Alinhamento inicial de expectativas e coleta de informa√ß√µes macro.', checklist: [{ text: 'Reuni√£o agendada', completed: false }, { text: 'Briefing preenchido', completed: false }] },
                    { title: 'Coleta de Produtos e Servi√ßos', description: 'Receber a lista completa de servi√ßos (cortes, barba, etc.), produtos, pre√ßos e dura√ß√µes para configurar o agendamento da IA.', checklist: [{ text: 'Lista de servi√ßos recebida', completed: false }, { text: 'Pre√ßos e dura√ß√µes definidos', completed: false }, { text: 'Produtos √† venda listados', completed: false }] }
                ]},
                { id: 'inprogress', title: '‚öôÔ∏è Em Andamento', tasks: [
                    { title: 'Cria√ß√£o da Conta Google', description: 'Setup da conta do Google para integra√ß√£o com a agenda.', checklist: [{ text: 'Criar e-mail', completed: false }, { text: 'Configurar agenda', completed: false }] },
                    { title: 'Configura√ß√£o T√©cnica da IA', description: 'Passagem do acesso para o cliente conectar o n√∫mero e bloqueio de grupos.', checklist: [{ text: 'Criar inst√¢ncia da Laura', completed: false }, { text: 'Passar acesso ao cliente', completed: false }, { text: 'Configurar bloqueio de grupos', completed: false }] },
                    { title: 'Cria√ß√£o das Campanhas', description: 'Desenvolvimento das campanhas de reativa√ß√£o e fidelidade.', checklist: [] }
                ]},
                { id: 'validation', title: 'ü§ù Em Valida√ß√£o', tasks: [] },
                { id: 'training', title: 'üöÄ Treinamento / Go-Live', tasks: [
                    { title: 'Ativa√ß√£o das Campanhas', description: 'Ligar as automa√ß√µes de marketing para os clientes.', checklist: [] }
                ]},
                { id: 'done', title: '‚úÖ Conclu√≠do', tasks: [
                    { title: 'Reuni√£o de Acompanhamento', description: 'An√°lise da primeira semana de funcionamento.', checklist: [] }
                ]}
            ]
        };

        // --- ESTRUTURA DE DADOS INICIAL ---
        const initialData = [
            {
                id: 'proj-1723402080000',
                name: 'Resenha Barbearia',
                columns: JSON.parse(JSON.stringify(projectTemplate.columns)) // Usa o template como base
            },
            {
                id: 'proj-1723402080001',
                name: 'Conveni√™ncia Santa Isabel',
                columns: [
                    { id: 'todo', title: 'üìã A Fazer / Briefing', tasks: [
                        { id: 'task-csi1', title: '[CLIENTE] Envio do Documento Base', description: 'Receber o documento com a lista de produtos e informa√ß√µes para o e-commerce.', checklist: [{ text: 'Documento recebido', completed: true }] }
                    ]},
                    { id: 'inprogress', title: '‚öôÔ∏è Em Andamento', tasks: [
                        { id: 'task-csi2', title: 'Cria√ß√£o de Listas de Clientes', description: 'Importar e segmentar a base de clientes para as campanhas.', checklist: [] },
                        { id: 'task-csi3', title: 'Desenvolvimento das Campanhas', description: 'Criar as campanhas de delivery e promo√ß√µes rel√¢mpago.', checklist: [] }
                    ]},
                    { id: 'validation', title: 'ü§ù Em Valida√ß√£o', tasks: [] },
                    { id: 'training', title: 'üöÄ Treinamento / Go-Live', tasks: [] },
                    { id: 'done', title: '‚úÖ Conclu√≠do', tasks: [] }
                ]
            }
        ];
        
        // Atribui IDs √∫nicos √†s tarefas do projeto de exemplo inicial
        initialData[0].columns.forEach(col => col.tasks.forEach(task => task.id = `task-rb-${Date.now() + Math.random()}`));

        // --- ESTADO DA APLICA√á√ÉO ---
        let projects = [];
        let currentProjectId = null;

        // --- FUN√á√ïES DE DADOS (LOCAL STORAGE) ---
        function loadProjectsFromStorage() {
            const storedProjects = localStorage.getItem('kanbanProjects');
            if (storedProjects) {
                projects = JSON.parse(storedProjects);
            } else {
                projects = initialData;
            }
            currentProjectId = localStorage.getItem('currentKanbanProject') || (projects.length > 0 ? projects[0].id : null);
        }

        function saveProjectsToStorage() {
            localStorage.setItem('kanbanProjects', JSON.stringify(projects));
            localStorage.setItem('currentKanbanProject', currentProjectId);
        }

        // --- L√ìGICA PRINCIPAL ---
        function renderBoard() {
            const project = projects.find(p => p.id === currentProjectId);
            const boardContainer = document.getElementById('board-container');
            
            if (!project) {
                boardContainer.innerHTML = '<p class="text-center text-gray-400 w-full">Nenhum projeto selecionado. Adicione um novo projeto para come√ßar.</p>';
                return;
            }

            boardContainer.innerHTML = ''; 
            project.columns.forEach(column => {
                const columnEl = document.createElement('div');
                columnEl.className = 'kanban-column p-4 flex flex-col';
                columnEl.dataset.columnId = column.id;
                columnEl.innerHTML = `
                    <h2 class="text-lg font-bold mb-4 text-gray-200 tracking-wider">${column.title}</h2>
                    <div class="task-list flex-grow space-y-4" data-column-id="${column.id}"></div>
                    <button class="add-task-btn w-full text-left p-2 mt-4 rounded-md font-semibold"><i class="fas fa-plus mr-2"></i> Adicionar Tarefa</button>
                `;
                const taskListEl = columnEl.querySelector('.task-list');
                column.tasks.forEach(task => taskListEl.appendChild(createTaskElement(task)));
                columnEl.querySelector('.add-task-btn').addEventListener('click', () => openTaskModal(null, column.id));
                boardContainer.appendChild(columnEl);
            });
            addDragAndDropListeners();
        }

        function renderClientSelector() {
            const selectEl = document.getElementById('client-select');
            selectEl.innerHTML = '';
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                if (project.id === currentProjectId) option.selected = true;
                selectEl.appendChild(option);
            });
            selectEl.disabled = projects.length === 0;
            document.getElementById('remove-project-btn').disabled = projects.length === 0;
        }

        function createTaskElement(task) {
            const taskEl = document.createElement('div');
            taskEl.className = 'kanban-card p-4 rounded-lg shadow-lg';
            taskEl.draggable = true;
            taskEl.dataset.taskId = task.id;
            const progress = calculateProgress(task.checklist);
            taskEl.innerHTML = `
                <button class="delete-task-btn" title="Remover Tarefa"><i class="fas fa-trash-alt"></i></button>
                <div class="pr-6">
                    <h3 class="font-semibold text-gray-100">${task.title}</h3>
                    <p class="text-sm text-gray-400 mt-2">${(task.description || '').substring(0, 70)}...</p>
                </div>
                <div class="mt-4">
                    <div class="flex justify-between items-center text-xs text-gray-400 mb-1">
                        <span>Progresso</span>
                        <span>${progress.completedCount}/${progress.totalCount}</span>
                    </div>
                    <div class="progress-bar-bg w-full h-2 rounded-full overflow-hidden">
                        <div class="progress-bar-fg h-full" style="width: ${progress.percentage}%;"></div>
                    </div>
                </div>
            `;
            taskEl.addEventListener('click', e => !e.target.closest('.delete-task-btn') && openTaskModal(task.id));
            taskEl.querySelector('.delete-task-btn').addEventListener('click', e => {
                e.stopPropagation();
                handleRemoveTask(task.id);
            });
            return taskEl;
        }

        // --- L√ìGICA DO MODAL ---
        function openTaskModal(taskId, columnId = null) {
            const project = projects.find(p => p.id === currentProjectId);
            let task = null;
            const isNewTask = taskId === null;

            if (!isNewTask) {
                for (const col of project.columns) {
                    const foundTask = col.tasks.find(t => t.id === taskId);
                    if (foundTask) { task = foundTask; break; }
                }
            }
            
            const modal = document.getElementById('task-modal');
            const modalContent = document.getElementById('modal-content');
            const title = isNewTask ? '' : task.title;
            const description = isNewTask ? '' : task.description;
            const checklist = isNewTask ? [] : (task.checklist || []);

            let checklistHTML = checklist.map((item, index) => `
                <div class="flex items-center p-2 group">
                    <label class="flex items-center flex-grow cursor-pointer">
                        <input type="checkbox" class="checkbox-dark h-5 w-5 rounded border-gray-500" data-task-id="${taskId}" data-checklist-index="${index}" ${item.completed ? 'checked' : ''}>
                        <span class="ml-3 text-gray-300 ${item.completed ? 'line-through text-gray-500' : ''}">${item.text}</span>
                    </label>
                    <button class="remove-checklist-item-btn text-gray-500 hover:text-red-400 ml-auto opacity-0 group-hover:opacity-100" data-task-id="${taskId}" data-checklist-index="${index}"><i class="fas fa-times"></i></button>
                </div>
            `).join('');

            modalContent.innerHTML = `
                <form id="task-form" class="p-6">
                    <div class="flex justify-between items-start mb-4"><h2 class="text-2xl font-bold text-white">${isNewTask ? 'Nova Tarefa' : 'Editar Tarefa'}</h2><button type="button" id="close-modal-btn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div>
                    <div class="mb-4"><label for="task-title" class="block text-sm font-medium text-gray-300 mb-1">T√≠tulo</label><input type="text" id="task-title" value="${title}" class="input-dark w-full p-2 rounded-md" required></div>
                    <div class="mb-6"><label for="task-description" class="block text-sm font-medium text-gray-300 mb-1">Descri√ß√£o</label><textarea id="task-description" rows="3" class="textarea-dark w-full p-2 rounded-md">${description || ''}</textarea></div>
                    ${!isNewTask ? `
                    <h3 class="font-semibold mb-2 text-gray-200">Checklist</h3>
                    <div id="checklist-container" class="space-y-1">${checklistHTML}</div>
                    <div class="flex mt-2"><input type="text" id="new-checklist-item" class="input-dark w-full p-2 rounded-md" placeholder="Adicionar item..."><button type="button" id="add-checklist-item-btn" class="ml-2 btn btn-indigo">Add</button></div>` : ''}
                    <div class="mt-6 flex justify-end"><button type="submit" class="btn btn-indigo">${isNewTask ? 'Criar Tarefa' : 'Salvar'}</button></div>
                </form>
            `;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.getElementById('close-modal-btn').addEventListener('click', closeTaskModal);
            document.getElementById('task-form').addEventListener('submit', e => { e.preventDefault(); handleSaveTask(taskId, columnId); });

            if (!isNewTask) {
                document.getElementById('add-checklist-item-btn').addEventListener('click', () => handleAddChecklistItem(taskId));
                modalContent.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.addEventListener('change', handleChecklistChange));
                modalContent.querySelectorAll('.remove-checklist-item-btn').forEach(btn => btn.addEventListener('click', handleRemoveChecklistItem));
            }
        }

        function closeTaskModal() { document.getElementById('task-modal').classList.add('hidden'); }

        // --- MANIPULA√á√ÉO DE DADOS (LOCAL) ---
        function handleSaveTask(taskId, columnId) {
            const title = document.getElementById('task-title').value;
            if (!title) return alert('O t√≠tulo √© obrigat√≥rio.');
            const description = document.getElementById('task-description').value;
            const project = projects.find(p => p.id === currentProjectId);

            if (taskId) { // Editar
                for (const col of project.columns) {
                    const task = col.tasks.find(t => t.id === taskId);
                    if (task) { task.title = title; task.description = description; break; }
                }
            } else { // Criar
                const targetColumn = project.columns.find(c => c.id === columnId);
                targetColumn.tasks.push({ id: 'task-' + Date.now(), title, description, checklist: [] });
            }
            saveProjectsToStorage();
            renderBoard();
            closeTaskModal();
        }

        function handleRemoveTask(taskId) {
            if (!confirm('Tem certeza que deseja remover esta tarefa?')) return;
            const project = projects.find(p => p.id === currentProjectId);
            for (const col of project.columns) {
                const taskIndex = col.tasks.findIndex(t => t.id === taskId);
                if (taskIndex > -1) { col.tasks.splice(taskIndex, 1); break; }
            }
            saveProjectsToStorage();
            renderBoard();
        }
        
        function handleAddChecklistItem(taskId) {
            const input = document.getElementById('new-checklist-item');
            const text = input.value.trim();
            if (!text) return;
            const project = projects.find(p => p.id === currentProjectId);
            for (const col of project.columns) {
                const task = col.tasks.find(t => t.id === taskId);
                if (task) {
                    task.checklist = task.checklist || [];
                    task.checklist.push({ text, completed: false });
                    break;
                }
            }
            saveProjectsToStorage();
            openTaskModal(taskId); // Reabre o modal para atualizar a lista
        }

        function handleRemoveChecklistItem(event) {
            const { taskId, checklistIndex } = event.currentTarget.dataset;
            const project = projects.find(p => p.id === currentProjectId);
            for (const col of project.columns) {
                const task = col.tasks.find(t => t.id === taskId);
                if (task) {
                    task.checklist.splice(checklistIndex, 1);
                    break;
                }
            }
            saveProjectsToStorage();
            openTaskModal(taskId);
        }

        function handleChecklistChange(event) {
            const { taskId, checklistIndex } = event.target.dataset;
            const project = projects.find(p => p.id === currentProjectId);
            for (const col of project.columns) {
                const task = col.tasks.find(t => t.id === taskId);
                if (task) { task.checklist[checklistIndex].completed = event.target.checked; break; }
            }
            saveProjectsToStorage();
            renderBoard(); // Apenas atualiza o board, n√£o reabre o modal
            openTaskModal(taskId); // Reabre para atualizar o texto riscado
        }

        function handleClientChange(event) {
            currentProjectId = event.target.value;
            saveProjectsToStorage();
            renderBoard();
        }

        function handleAddProject() {
            const name = prompt("Digite o nome do novo projeto:");
            if (!name) return;

            // Cria uma c√≥pia profunda do template para evitar refer√™ncias compartilhadas
            const newColumns = JSON.parse(JSON.stringify(projectTemplate.columns));
            
            // Atribui IDs √∫nicos a cada nova tarefa clonada
            newColumns.forEach(column => {
                column.tasks.forEach(task => {
                    task.id = 'task-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                });
            });

            const newProject = {
                id: 'proj-' + Date.now(),
                name,
                columns: newColumns
            };
            
            projects.push(newProject);
            currentProjectId = newProject.id;
            saveProjectsToStorage();
            renderClientSelector();
            renderBoard();
        }

        function handleRemoveProject() {
            if (projects.length === 0) return;
            const projectToRemove = projects.find(p => p.id === currentProjectId);
            if (!confirm(`Tem certeza que deseja remover o projeto "${projectToRemove.name}"? Esta a√ß√£o n√£o pode ser desfeita.`)) return;
            
            projects = projects.filter(p => p.id !== currentProjectId);
            currentProjectId = projects.length > 0 ? projects[0].id : null;
            saveProjectsToStorage();
            renderClientSelector();
            renderBoard();
        }

        function calculateProgress(checklist) {
            if (!checklist || checklist.length === 0) return { totalCount: 0, completedCount: 0, percentage: 0 };
            const totalCount = checklist.length;
            const completedCount = checklist.filter(item => item.completed).length;
            const percentage = totalCount > 0 ? (completedCount / totalCount) * 100 : 0;
            return { totalCount, completedCount, percentage };
        }
        
        // --- DRAG AND DROP ---
        function addDragAndDropListeners() {
            const cards = document.querySelectorAll('.kanban-card');
            const columns = document.querySelectorAll('.task-list');
            cards.forEach(card => {
                card.addEventListener('dragstart', () => card.classList.add('dragging'));
                card.addEventListener('dragend', () => card.classList.remove('dragging'));
            });
            columns.forEach(column => {
                column.addEventListener('dragover', e => { e.preventDefault(); column.classList.add('drag-over'); });
                column.addEventListener('dragleave', () => column.classList.remove('drag-over'));
                column.addEventListener('drop', e => {
                    e.preventDefault();
                    column.classList.remove('drag-over');
                    const draggingCard = document.querySelector('.dragging');
                    if (draggingCard) moveTask(draggingCard.dataset.taskId, column.dataset.columnId);
                });
            });
        }
        
        function moveTask(taskId, targetColumnId) {
            const project = projects.find(p => p.id === currentProjectId);
            let taskToMove = null;
            for (const col of project.columns) {
                const taskIndex = col.tasks.findIndex(t => t.id === taskId);
                if (taskIndex > -1) { taskToMove = col.tasks.splice(taskIndex, 1)[0]; break; }
            }
            if (taskToMove) {
                const targetColumn = project.columns.find(c => c.id === targetColumnId);
                targetColumn.tasks.push(taskToMove);
                saveProjectsToStorage();
                renderBoard(); 
            }
        }

        // --- INICIALIZA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', () => {
            loadProjectsFromStorage();
            renderClientSelector();
            renderBoard();
            document.getElementById('client-select').addEventListener('change', handleClientChange);
            document.getElementById('add-project-btn').addEventListener('click', handleAddProject);
            document.getElementById('remove-project-btn').addEventListener('click', handleRemoveProject);
            
            // Fecha o modal se clicar fora do conte√∫do
            document.getElementById('task-modal').addEventListener('click', (e) => {
                if(e.target.id === 'task-modal') {
                    closeTaskModal();
                }
            });
        });
    </script>
</body>
</html>
